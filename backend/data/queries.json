[
  {
    "id": "c8e17a23-c5c7-4c25-b7b7-886b8d3379a5",
    "name": "Facturas con pagos y Saldos desde 2020",
    "description": "Facturas con pagos y Saldos desde 2020 muestra ordenado por fecha y nombre cliente",
    "sql": "WITH facturas AS (\n    SELECT\n        ai.id,\n        ai.number                    AS factura,\n        rp.name                      AS cliente,\n        ai.date_invoice::date        AS fecha_factura,\n        ai.amount_total              AS monto_total,\n        ai.move_id\n    FROM account_invoice ai\n    JOIN res_partner rp ON rp.id = ai.partner_id\n    WHERE ai.type = 'out_invoice'\n      AND ai.date_invoice BETWEEN '2020-01-01' AND '2024-12-31'\n),\n\nlinea_factura AS (\n    SELECT\n        f.*,\n        aml.id                AS aml_fact_id,\n        aml.reconcile_id\n    FROM facturas f\n    JOIN account_move_line aml\n         ON aml.move_id = f.move_id\n    WHERE aml.debit > 0\n),\n\npagos AS (\n    SELECT\n        lf.id,\n        av.number        AS recibo,\n        av.date::date    AS fecha_pago,\n        LEAST(ABS(aml_pago.credit), ABS(aml_fact.debit)) AS monto_pagado\n    FROM linea_factura lf\n    JOIN account_move_line aml_fact ON aml_fact.id = lf.aml_fact_id\n    JOIN account_move_line aml_pago\n         ON aml_pago.reconcile_id = aml_fact.reconcile_id\n        AND aml_pago.id <> aml_fact.id\n    JOIN account_voucher av\n         ON av.move_id = aml_pago.move_id\n        AND av.state='posted'\n),\n\npagos_ordenados AS (\n    SELECT\n        f.id,\n        f.factura,\n        f.cliente,\n        f.fecha_factura,\n        f.monto_total,\n        p.recibo,\n        p.fecha_pago,\n        p.monto_pagado,\n        SUM(p.monto_pagado)\n            OVER (PARTITION BY f.id ORDER BY p.fecha_pago) AS acumulado\n    FROM facturas f\n    LEFT JOIN pagos p ON p.id = f.id\n),\n\nestado_final AS (\n    SELECT\n        factura,\n        cliente,\n        fecha_factura,\n        monto_total,\n        recibo,\n        fecha_pago,\n        COALESCE(monto_pagado,0) AS monto_pagado,\n        (monto_total - COALESCE(acumulado,0)) AS saldo\n    FROM pagos_ordenados\n)\n\nSELECT *\nFROM estado_final\nWHERE saldo > 0\nORDER BY\n    EXTRACT(YEAR FROM fecha_factura) ASC,\n    cliente ASC,\n    factura ASC,\n    fecha_pago NULLS FIRST;",
    "dbType": "postgres",
    "createdAt": "2026-02-20T23:58:33.578Z",
    "updatedAt": "2026-02-20T23:58:33.578Z"
  },
  {
    "id": "7a937c70-bf10-4186-8fcd-0078668ffe34",
    "name": "Facturas completas desde 2020",
    "description": "Facturas completas desde 2020 con saldo 0 incluidos",
    "sql": "WITH facturas AS (\n    SELECT\n        ai.id,\n        ai.number                    AS factura,\n        rp.name                      AS cliente,\n        ai.date_invoice::date        AS fecha_factura,\n        ai.amount_total              AS monto_total,\n        ai.move_id\n    FROM account_invoice ai\n    JOIN res_partner rp ON rp.id = ai.partner_id\n    WHERE ai.type = 'out_invoice'\n      AND ai.date_invoice BETWEEN '2020-01-01' AND '2024-12-31'\n),\n\nlinea_factura AS (\n    SELECT\n        f.*,\n        aml.id                AS aml_fact_id,\n        aml.reconcile_id\n    FROM facturas f\n    JOIN account_move_line aml\n         ON aml.move_id = f.move_id\n    WHERE aml.debit > 0          -- solo l√≠nea cliente (cuenta por cobrar)\n),\n\npagos AS (\n    SELECT\n        lf.id,\n        av.number        AS recibo,\n        av.date::date    AS fecha_pago,\n\n        LEAST(ABS(aml_pago.credit), ABS(aml_fact.debit)) AS monto_pagado\n\n    FROM linea_factura lf\n\n    JOIN account_move_line aml_fact ON aml_fact.id = lf.aml_fact_id\n\n    JOIN account_move_line aml_pago\n         ON aml_pago.reconcile_id = aml_fact.reconcile_id\n        AND aml_pago.id <> aml_fact.id\n\n    JOIN account_voucher av\n         ON av.move_id = aml_pago.move_id\n        AND av.state='posted'\n),\n\npagos_ordenados AS (\n    SELECT\n        f.factura,\n        f.cliente,\n        f.fecha_factura,\n        f.monto_total,\n        p.recibo,\n        p.fecha_pago,\n        p.monto_pagado,\n\n        SUM(p.monto_pagado)\n            OVER (PARTITION BY f.id ORDER BY p.fecha_pago) AS acumulado\n\n    FROM facturas f\n    LEFT JOIN pagos p ON p.id = f.id\n)\n\nSELECT\n    factura,\n    cliente,\n    fecha_factura,\n    monto_total,\n\n    recibo,\n    fecha_pago,\n    COALESCE(monto_pagado,0) AS monto_pagado,\n\n    (monto_total - COALESCE(acumulado,0)) AS saldo\n\nFROM pagos_ordenados\nORDER BY factura, fecha_pago NULLS FIRST;",
    "dbType": "postgres",
    "createdAt": "2026-02-20T23:59:35.471Z",
    "updatedAt": "2026-02-20T23:59:35.471Z"
  }
]